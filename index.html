<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Clasificador FRISA + Asistente IA</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.7.4"></script>

  <style>
    :root { --main-color:#C8102E; --neutral-color:#7D7D7D; }
    * { box-sizing:border-box; }

    body {
      font-family:"Inter",sans-serif;
      background:#2E2E2E;
      color:#FFF;
      display:flex;
      justify-content:center;
      padding:20px;
    }

    .container {
      background:white;
      color:#2E2E2E;
      border-radius:16px;
      padding:40px;
      width:950px;
      max-width:100%;
      box-shadow:0 8px 32px rgba(0,0,0,0.25);
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:40px;
    }

    .logo-container, h1, footer {
      grid-column:span 2;
      text-align:center;
    }

    input[type="file"]{
      width:100%; padding:12px;
      border:2px dashed var(--main-color);
      border-radius:10px;
      cursor:pointer;
      background:#F9F9F9;
    }

    #preview {
      margin-top:20px; width:260px; height:260px;
      display:none; object-fit:cover;
      border-radius:12px; border:3px solid var(--main-color);
    }

    #result {
      margin-top:20px; font-size:1.2em; padding:12px;
      border-radius:10px; display:none;
    }

    #result.defectuosa { background:rgba(200,16,46,0.15); border:1px solid var(--main-color); color:var(--main-color); }
    #result.no_defectuosa { background:rgba(125,125,125,0.15); border:1px solid var(--neutral-color); color:var(--neutral-color); }

    /* ------------------------- */
    /*   CAMPO ID DE LA PIEZA   */
    /* ------------------------- */
    .id-box {
      margin-top:15px;
      display:flex;
      gap:10px;
      align-items:center;
      display:none;
    }

    .id-box input {
      flex:1;
      padding:10px;
      border-radius:8px;
      border:1px solid #CCC;
      font-size:15px;
      background:#F5F5F5;
    }

    #addHistoryBtn {
      padding:10px 16px;
      background:var(--main-color);
      color:white;
      border:none;
      border-radius:8px;
      cursor:pointer;
      font-weight:700;
    }

    /* ----------------------------- */
    /*   BOT√ìN PREGUNTAR A LA IA    */
    /* ----------------------------- */
    #sendPrompt {
      width:100%;
      margin-top:10px;
      padding:14px;
      background:#6E6E6E;
      color:white;
      border:none;
      border-radius:25px; /* üëà redondo */
      cursor:pointer;
      font-weight:700;
      font-size:15px;
    }

    #sendPrompt:hover { filter:brightness(.8); }

    textarea {
      width:100%; min-height:90px;
      padding:10px; border-radius:8px; border:1px solid #7D7D7D;
    }

    #responseBox {
      display:none;
      background:#F4F4F4;
      border-radius:8px;
      padding:12px;
      margin-top:10px;
      min-height:40px;
      color:#2E2E2E;
      white-space:pre-line;
    }

    /* ----------------------------- */
    /* TABLA HISTORIAL              */
    /* ----------------------------- */
    table {
      width:100%;
      border-collapse:collapse;
      margin-top:20px;
      background:white;
      border-radius:12px;
      overflow:hidden;
      text-align:center;
    }

    th {
      background:#C8102E;
      color:white;
      padding:6px;
      font-size:14px;
      line-height:16px;
      white-space:pre-line;
    }

    td {
      padding:6px;
      border-bottom:1px solid #ddd;
    }

    .red { color:#C8102E; font-weight:bold; }
  </style>
</head>

<body>
  <div class="container">

    <div class="logo-container">
      <img src="FRISA.png" width="120">
    </div>

    <h1>Clasificador de Im√°genes</h1>

    <!-- COLUMNA IZQUIERDA -->
    <div>
      <p>Sube una imagen para detectar si est√° <b>Defectuosa</b> o <b>No defectuosa</b>.</p>

      <input type="file" id="imageInput" accept="image/*">
      <img id="preview">

      <p id="result"></p>

      <!-- ‚≠ê CAMPO PARA ID DE PIEZA DENTRO DE LA P√ÅGINA -->
      <div class="id-box" id="idBox">
        <label style="font-weight:bold;">ID pieza</label>
        <input id="piezaID" placeholder="Ej: AAA-555">
        <button id="addHistoryBtn">A√±adir al historial</button>
      </div>

      <table id="historyTable">
        <thead>
          <tr>
            <th>ID Pieza</th>
            <th>TiempoDelta<br>Maquinados</th>
            <th>ConfAlturaCaliente<br>Rolas</th>
            <th>TiempoEnHorno<br>Hornos</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- ASISTENTE IA -->
    <div class="helpdesk">
      <h2>üí¨ Asistente IA FRISA</h2>

      <textarea id="promptInput" placeholder="Haz una pregunta sobre la pieza, defectos, acci√≥n recomendada, etc..."></textarea>

      <!-- üî• BOT√ìN DE IA MODIFICADO A GRIS Y REDONDO -->
      <button id="sendPrompt">Preguntar a la IA</button>

      <div id="responseBox"></div>
    </div>

    <footer>üß† FRISA | Clasificador + Asistente IA</footer>
  </div>

  <canvas id="cropCanvas" style="display:none;"></canvas>

<script>
let model, metadata;
let lastPredictionJson = null;
let lastImageB64 = null;

async function loadModel() {
  model = await tf.loadLayersModel("model.json");
  const meta = await fetch("metadata.json");
  metadata = await meta.json();
}

/* --------------------------
   CLASIFICACI√ìN
--------------------------- */
async function predict() {
  const img = document.getElementById("preview");
  const resultBox = document.getElementById("result");
  const idBox = document.getElementById("idBox");

  const size = Math.min(img.width, img.height);
  const sx = (img.width - size) / 2;
  const sy = (img.height - size) / 2;

  let tensor = tf.browser.fromPixels(img)
    .slice([sy, sx, 0], [size, size, 3])
    .resizeBilinear([metadata.imageSize, metadata.imageSize])
    .toFloat().div(127.5).sub(1).expandDims(0);

  let logits = model.predict(tensor);
  if (!Array.isArray(logits)) logits = tf.softmax(logits);

  const prediction = await logits.data();
  tf.dispose([tensor, logits]);

  const labels = metadata.labels;

  const results = Array.from(prediction).map((p, i) => ({
    label: labels[i],
    prob: (p*100).toFixed(2)
  })).sort((a,b)=>b.prob-a.prob);

  lastPredictionJson = JSON.stringify(results);
  const top = results[0];

  resultBox.textContent = `Predicci√≥n: ${top.label} (${top.prob}%)`;
  resultBox.style.display = "block";

  if (top.label.toLowerCase().includes("no"))
      resultBox.className = "no_defectuosa";
  else
      resultBox.className = "defectuosa";

  document.getElementById("idBox").style.display = "flex";

  const canvas = document.getElementById("cropCanvas");
  canvas.width = metadata.imageSize;
  canvas.height = metadata.imageSize;
  const ctx = canvas.getContext("2d");

  ctx.drawImage(img, sx, sy, size, size, 0, 0, metadata.imageSize, metadata.imageSize);
  lastImageB64 = canvas.toDataURL("image/jpeg", 0.9).split(",")[1];
}

document.getElementById("imageInput").onchange = e => {
  const file = e.target.files[0];
  if (!file) return;

  const img = document.getElementById("preview");
  img.src = URL.createObjectURL(file);

  img.onload = () => {
    img.style.display = "block";
    predict();
  };
};

/* ------------------------------------
   A√ëADIR AL HISTORIAL DESDE EL CAMPO
------------------------------------- */
document.getElementById("addHistoryBtn").onclick = () => {
  const piezaID = document.getElementById("piezaID").value.trim();
  if (!piezaID) return alert("Ingrese el ID de la pieza.");

  const tbody = document.querySelector("#historyTable tbody");

  const row = `
    <tr>
      <td>${piezaID}</td>
      <td class="red">125</td>
      <td>12</td>
      <td>17</td>
    </tr>
  `;

  tbody.innerHTML += row;

  resetApp();
};

/* --------------------------
   REINICIAR APP
--------------------------- */
function resetApp() {
  document.getElementById("preview").style.display = "none";
  document.getElementById("preview").src = "";
  document.getElementById("imageInput").value = "";
  document.getElementById("result").innerHTML = "";
  document.getElementById("result").style.display = "none";
  document.getElementById("idBox").style.display = "none";
  document.getElementById("piezaID").value = "";
  lastImageB64 = null;
  lastPredictionJson = null;
}

/* --------------------------
   ASISTENTE IA
--------------------------- */
document.getElementById("sendPrompt").onclick = async () => {
  const prompt = document.getElementById("promptInput").value.trim();
  const box = document.getElementById("responseBox");

  if (!prompt) return alert("Escribe una pregunta.");

  box.style.display = "block";
  box.innerHTML = "üí≠ Consultando IA...";

  try {
    const res = await fetch("/api/aoai-chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        prompt,
        prediccionJson: lastPredictionJson,
        imageB64: lastImageB64
      })
    });

    const data = await res.json();
    let texto = data.answer || data.reply || data.message || "";

    texto = texto
      .replace(/\*\*(.*?)\*\*/g, "<b>$1</b>")
      .replace(/\n\n/g, "<br><br>")
      .replace(/\n/g, "<br>");

    box.innerHTML = texto;

  } catch (err) {
    box.innerHTML = "‚ùå Error de conexi√≥n con el servidor.";
  }
};

loadModel();
</script>

</body>
</html>
