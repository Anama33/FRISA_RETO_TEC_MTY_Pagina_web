<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Clasificador FRISA + Asistente IA</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.7.4"></script>

  <style>
    :root { --main-color:#C8102E; --neutral-color:#7D7D7D; }
    * { box-sizing:border-box; }

  body {
    font-family:"Inter",sans-serif;
    background:white;       /*  ‚Üê fondo totalmente blanco */
    color:#2E2E2E;          /*  ‚Üê texto oscuro */
    min-height:100vh;       /*  ‚Üê cubre toda la pantalla */
    margin:0;
    padding:0;
    display:flex;
    justify-content:center;
    align-items:flex-start; /*  ‚Üê para centrar el contenido arriba */
}


  .container {
    background:white;
    color:#2E2E2E;
    border-radius:16px;
    padding:40px;
    width:900px;
    max-width:100%;
    margin-top:40px; /* ‚Üê separa del borde superior */
    box-shadow:0 8px 32px rgba(0,0,0,0.15);
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:40px;
}


    .logo-container, h1, footer {
      grid-column:span 2;
      text-align:center;
    }

    input[type="file"]{
      width:100%; padding:12px;
      border:2px dashed var(--main-color);
      border-radius:10px;
      cursor:pointer;
      background:#F9F9F9;
    }

    #preview {
      margin-top:20px; width:260px; height:260px;
      display:none; object-fit:cover;
      border-radius:12px; border:3px solid var(--main-color);
    }

    #result {
      margin-top:20px; font-size:1.2em; padding:12px;
      border-radius:10px; display:none;
    }

    #result.defectuosa {
      background:rgba(200,16,46,0.15);
      border:1px solid var(--main-color);
      color:var(--main-color);
    }

    #result.no_defectuosa {
      background:rgba(125,125,125,0.15);
      border:1px solid var(--neutral-color);
      color:var(--neutral-color);
    }

    textarea {
      width:100%; min-height:90px;
      padding:10px; border-radius:8px; border:1px solid #7D7D7D;
    }

    #sendPrompt {
      background:#6c6c6c;
      color:white;
      border:none;
      font-weight:700;
      margin-top:10px;
      padding:13px 20px;
      border-radius:40px;
      cursor:pointer;
      width:100%;
    }

    #sendPrompt:hover { filter:brightness(.9); }

    #responseBox {
      display:none;
      background:#F4F4F4;
      border-radius:8px;
      padding:12px;
      margin-top:10px;
      min-height:40px;
      color:#2E2E2E;
      white-space:pre-line;
    }

    /* ---------------- HISTORIAL ---------------- */

    .history-box {
      margin-top:20px;
      padding:15px;
      background:#f7f7f7;
      border-radius:12px;
      display:none;
    }

    .history-row {
      display:flex;
      gap:15px;
      align-items:center;
      margin-bottom:15px;
    }

    .history-row input {
      flex:1;
      padding:10px;
      border:1px solid #aaa;
      border-radius:10px;
    }

    .history-row button {
      padding:10px 20px;
      background:var(--main-color);
      color:white;
      border:none;
      border-radius:10px;
      cursor:pointer;
    }

    .history-row button:hover { filter:brightness(.9); }

    table {
      width:100%;
      border-collapse:collapse;
      margin-top:15px;
      background:white;
      border-radius:10px;
      font-size:0.75rem; /* 25% m√°s peque√±o */
      display:none;
    }

    th, td {
      padding:8px;
      border-bottom:1px solid #ccc;
      text-align:left;
    }

    th { background:#e6e6e6; }

    .red { color:red; font-weight:bold; }
  </style>
</head>

<body>
  <div class="container">

    <div class="logo-container">
      <img src="FRISA.png" width="120">
    </div>

    <h1>Clasificador de Im√°genes</h1>

    <!-- COLUMNA IZQUIERDA -->
    <div>
      <p>Sube una imagen para detectar si est√° <b>Defectuosa</b> o <b>No defectuosa</b>.</p>

      <input type="file" id="imageInput">
      <img id="preview">
      <p id="result"></p>

      <!-- CUADRO DE ID Y BOT√ìN -->
      <div class="history-box" id="historyBox">
        <div class="history-row">
          <input id="piezaID" placeholder="ID pieza (ej: AAA-555)">
          <button id="addHistoryBtn">A√±adir al historial</button>
        </div>
      </div>

      <!-- TABLA -->
      <table id="historyTable">
        <thead>
          <tr>
            <th>ID pieza</th>
            <th>TiempoDelta<br>Maquinados</th>
            <th>ConfAlturaCaliente<br>Rolas</th>
            <th>TiempoEn<br>Horno</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- IA -->
    <div class="helpdesk">
      <h2>üí¨ Asistente IA FRISA</h2>

      <textarea id="promptInput" placeholder="Pregunta algo sobre la pieza..."></textarea>
      <button id="sendPrompt">Preguntar a la IA</button>
      <div id="responseBox"></div>
    </div>

    <footer>üß† FRISA | Clasificador + Asistente IA</footer>

  </div>

  <canvas id="cropCanvas" style="display:none;"></canvas>

<script>
let model, metadata;
let lastPredictionJson = null;
let lastImageB64 = null;

async function loadModel() {
  model = await tf.loadLayersModel("model.json");
  const meta = await fetch("metadata.json");
  metadata = await meta.json();
}

// ------------ CLASIFICACI√ìN ------------
async function predict() {
  const img = document.getElementById("preview");
  const resultBox = document.getElementById("result");

  const size = Math.min(img.width, img.height);
  let sx = (img.width - size) / 2;
  let sy = (img.height - size) / 2;

  let tensor = tf.browser.fromPixels(img)
    .slice([sy, sx, 0], [size, size, 3])
    .resizeBilinear([metadata.imageSize, metadata.imageSize])
    .toFloat().div(127.5).sub(1).expandDims(0);

  let logits = tf.softmax(model.predict(tensor));
  const prediction = await logits.data();
  tf.dispose([tensor, logits]);

  const labels = metadata.labels;

  const results = Array.from(prediction).map((p, i) => ({
    label: labels[i], prob: (p*100).toFixed(2)
  })).sort((a,b)=>b.prob-a.prob);

  lastPredictionJson = JSON.stringify(results);

  const top = results[0];
  resultBox.textContent = `Predicci√≥n: ${top.label} (${top.prob}%)`;
  resultBox.style.display = "block";

  document.getElementById("historyBox").style.display = "block";

  if (top.label.toLowerCase().includes("no"))
      resultBox.className = "no_defectuosa";
  else
      resultBox.className = "defectuosa";

  const canvas = document.getElementById("cropCanvas");
  canvas.width = metadata.imageSize;
  canvas.height = metadata.imageSize;
  const ctx = canvas.getContext("2d");

  ctx.drawImage(img, sx, sy, size, size, 0, 0, metadata.imageSize, metadata.imageSize);
  lastImageB64 = canvas.toDataURL("image/jpeg", 0.9).split(",")[1];
}

document.getElementById("imageInput").onchange = e => {
  const file = e.target.files[0];
  if (!file) return;
  const img = document.getElementById("preview");
  img.src = URL.createObjectURL(file);
  img.onload = () => {
    img.style.display = "block";
    predict();
  };
};

// ------------ A√ëADIR AL HISTORIAL ------------
document.getElementById("addHistoryBtn").onclick = () => {
  const piezaID = document.getElementById("piezaID").value.trim();
  if (!piezaID) return alert("Ingrese el ID de la pieza.");

  const tabla = document.getElementById("historyTable");
  const tbody = tabla.querySelector("tbody");

  let valores;

  if (piezaID.toUpperCase().startsWith("O")) {
    valores = {
      delta: `80`,
      rolas: `15`,
      horno: `19`
    };
  } else {
    valores = {
      delta: `<span class="red">125</span>`,
      rolas: `12`,
      horno: `17`
    };
  }

  tbody.innerHTML += `
    <tr>
      <td>${piezaID}</td>
      <td>${valores.delta}</td>
      <td>${valores.rolas}</td>
      <td>${valores.horno}</td>
    </tr>
  `;

  tabla.style.display = "table";

  resetApp();
};

function resetApp() {
  document.getElementById("preview").style.display = "none";
  document.getElementById("preview").src = "";
  document.getElementById("result").style.display = "none";
  document.getElementById("imageInput").value = "";
  document.getElementById("piezaID").value = "";
  document.getElementById("historyBox").style.display = "none";
}

// ------------ IA ------------
document.getElementById("sendPrompt").onclick = async () => {
  const prompt = document.getElementById("promptInput").value.trim();
  const box = document.getElementById("responseBox");
  if (!prompt) return alert("Escribe una pregunta.");

  box.style.display = "block";
  box.innerHTML = "üí≠ Consultando IA...";

  try {
    const res = await fetch("/api/aoai-chat", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({
        prompt,
        prediccionJson:lastPredictionJson,
        imageB64:lastImageB64
      })
    });

    const data = await res.json();
    let texto = data.answer || data.reply || data.message || "";

    texto = texto
      .replace(/\*\*(.*?)\*\*/g, "<b>$1</b>")
      .replace(/\n\n/g, "<br><br>")
      .replace(/\n/g, "<br>");

    box.innerHTML = texto;

  } catch (err) {
    box.innerHTML = "‚ùå Error de conexi√≥n con el servidor.";
  }
};

loadModel();
</script>

</body>
</html>
